---
title: "Neanderthal Trauma Revisited (title pending)"
author: "James Bain"
date: "May, 2016"
output: html_document
---

Let's read in some packages first...oh...and set the working directory
```{r}
setwd(dir='Desktop/Spring 2016/Neander_Trauma/')

library(plyr)       
library(ggplot2)    
library(plotly)     
library(reshape)    
library(vcd)        
library(DescTools) 
```

Now it is time to read in the data and get into a workable format for our problem

```{r}
# read in the data
df <- read.csv('Data/NEISS/sport_category_final.csv')

# create a contigency table 
orig_table <- table(df$prod1,df$body_part)

# create a datafame from the contigency table (at least one that is intuitive)
tm<-as.data.frame.matrix(orig_table) # tm stands for table matrix
```

and some further cleanup. This time, we need to ensure that all of the classifications of the original data belong to the same categories of that in the Berger and Trinkaus paper.

```{r}
head_neck <- tm$face + tm$neck + tm$head
shoulder_arm <- tm$`upper arm` + tm$`lower arm` + tm$shoulder + tm$elbow
hand <- tm$hand + tm$finger + tm$wrist
pelvis <- tm$`pubic region` + tm$hip 
leg <- tm$knee + tm$`lower leg` + tm$`upper leg`
foot <- tm$foot + tm$toe + tm$ankle
trunk <- tm$`upper trunk` + tm$back
```

Now let's wrap this all into a final dataframe that we will use throughout the rest of this analysis.

```{r}
final<-as.data.frame(cbind(head_neck,shoulder_arm,hand,pelvis,leg,foot,trunk))
rownames(final)<-rownames(tm) # index will be the activity name
```

Grabbing the values off of the Berger and Trinkaus paper is the first task

```{r}
sample1<-c(8,4,7,1,1,3,3) # total sample
sample2<-c(7,4,7,1,0,3,1) # without djd
sample3<-c(6,4,5,1,1,3,1) # without shandidar 1
sample4<-c(5,4,5,1,0,3,0) # without djd or shandidar 1
```

Now it is time to run the actual analysis. We are going to create some tables the involve running a chi square test on all of the samples against all of the activities as well as calculating *Cramer's V*.

```{r}
# total sample
nt<-t(apply(final,1,function(x) {
  new<- cbind(sample1,x)
  ch <- chisq.test(new)
  chi<-c(unname(ch$statistic), ch$p.value)
  cram<-CramerV(new)
  cbind(chi,cram)
}))

# sample with out djd
nwd<-t(apply(final,1,function(x) {
  new<- cbind(sample2,x)
  ch <- chisq.test(new)
  chi<-c(unname(ch$statistic), ch$p.value)
  cram<-CramerV(new)
  cbind(chi,cram)
}))

# sample without shandidar
nws<-t(apply(final,1,function(x) {
  new<- cbind(sample3,x)
  ch <- chisq.test(new)
  chi<-c(unname(ch$statistic), ch$p.value)
  cram<-CramerV(new)
  cbind(chi,cram)
}))

# sample without shandidar or djd
nwsd<-t(apply(final,1,function(x) {
  new<- cbind(sample4,x)
  ch <- chisq.test(new)
  chi<-c(unname(ch$statistic), ch$p.value)
  cram<-CramerV(new)
  cbind(chi,cram)
}))
```

Create a function to clean up some vital information about the Chi Square test

```{r}
chi2cleanup<-function(table){
  
  # read in one of the chi square tables (nt, nwd, nws or nwsd)
  frame<-as.data.frame(table,row.names = rownames(table))
  frame<-frame[-c(4)] # drop the extra p value column
  names(frame) = c('X2','P-Value','Cramers V')
  fin = na.omit(frame) 
  
  # create two callable objects, 1) the rows that have NAs and 2) the final data frame for some final manipulation
  c<- list(
    rowna=frame[is.nan(frame$X2),],   # $rowna 
    final=fin,                        # $final
    similar=fin[fin$`P-Value` > .05,] # $similar (activities that are similar, P > 0.05)
  )
  return(c)
}
```

```{r}
# name cleaned up chi square tables
n_tot<-chi2cleanup(nt)  # neanderthal total
n_djd<-chi2cleanup(nwd) # neanderthal w/o djd
n_s<-chi2cleanup(nws)   # neanderthal w/o shan
n_sd<-chi2cleanup(nwsd) # neanderthal w/o shan or djd
```